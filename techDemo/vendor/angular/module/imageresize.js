angular.module("imageresize",[]).directive("image",function(e){"use strict";var i=window.URL||window.webkitURL,t=function(){var e="fileupload-resize-area",i=document.getElementById(e);return i||(i=document.createElement("canvas"),i.id=e,i.style.visibility="hidden",document.body.appendChild(i)),i},a=[],n=function(e,i){var n=i.resizeMaxWidth.split(",");a=[];for(var r=0;r<n.length;r++){var u=(n[r],n[r]),o=.01*i.resizeQuality,d=(i.resizeType||"image/jpg",t()),s=e.height,l=e.width;s=Math.round(s*=u/l),l=u,d.width=l,d.height=s;var c=d.getContext("2d");c.drawImage(e,0,0,l,s);var h=d.toDataURL("image/jpeg",1*o),g=h.length;a.push({base64:h,width:l,height:s,quality:o,size:g})}},r=function(e,i){var t=new Image;t.onload=function(){i(t)},t.src=e},u=function(i){var t=e.defer(),a=new FileReader;return a.onload=function(e){t.resolve(e.target.result)},a.readAsDataURL(i),t.promise};return{restrict:"A",scope:{image:"=",resizeMaxHeight:"@?",resizeMaxWidth:"@?",resizeQuality:"@?",resizeType:"@?"},link:function(e,t,o){var d=function(i,t){r(i.url,function(r){n(r,e);i.data=[];for(var u=0;u<a.length;u++)i.data.push({src:a[u].base64,width:a[u].width,height:a[u].height,quality:a[u].quality.toFixed(2),size:(a[u].size/1024).toFixed(2)+"kb"});t(i)})},s=function(i){e.$apply(function(){o.multiple?e.image.push(i):e.image=i})};t.bind("change",function(e){var t=e.target.files,a={file:t[0],url:i.createObjectURL(t[0])};u(t[0]).then(function(e){a.dataURL=e}),d(a,function(e){s(e)})})}}});